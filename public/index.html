<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Scramble - Multiplayer Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .setup {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        input {
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        input[type="text"] {
            flex: 2;
            min-width: 150px;
        }

        input[type="number"] {
            width: 80px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .info {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .info-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .board {
            display: grid;
            gap: 10px;
            margin: 20px auto;
            max-width: 600px;
        }

        .card {
            aspect-ratio: 1;
            min-width: 80px;
            min-height: 80px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            border: 3px solid transparent;
        }

        .card:hover:not(.none) {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .card.down {
            background: #4285f4;
            color: white;
        }

        .card.up {
            background: #fbbc04;
            color: #333;
        }

        .card.my {
            background: #ff6b6b;
            color: white;
            border-color: #c92a2a;
        }

        .card.none {
            background: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.3;
        }

        .status {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        #connection {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .connected {
            background: #34a853;
            color: white;
        }

        .disconnected {
            background: #ea4335;
            color: white;
        }

        .debug {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }
    </style>
</head>
<body>
    <div id="connection" class="disconnected">‚ö´ Disconnected</div>

    <div class="container">
        <h1>üéÆ Memory Scramble</h1>
        <p class="subtitle">MIT 6.102 Lab 3 - Multiplayer</p>

        <div class="setup">
            <input type="text" id="playerId" placeholder="Enter your name">
            <input type="number" id="width" placeholder="Width" value="4" min="2" max="6">
            <input type="number" id="height" placeholder="Height" value="4" min="2" max="6">
            <button onclick="startGame()">New Game</button>
            <button onclick="refreshBoard()">Refresh</button>
        </div>

        <div class="info">
            <div class="info-item">
                <div class="info-label">Player</div>
                <div class="info-value" id="player">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">Board Size</div>
                <div class="info-value" id="size">-</div>
            </div>
        </div>

        <div id="board" class="board"></div>
        <div id="status" class="status"></div>

        <div class="debug" id="debug"></div>
    </div>

    <script>
        let playerId = '';
        let ws = null;

        function log(msg) {
            console.log(msg);
            const debug = document.getElementById('debug');
            debug.innerHTML = `${new Date().toLocaleTimeString()}: ${msg}<br>` + debug.innerHTML;
        }

        function connectWS() {
            const wsUrl = `ws://${window.location.host}/ws`;
            log(`Connecting to ${wsUrl}`);

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    log('‚úÖ WebSocket connected');
                    document.getElementById('connection').textContent = 'üü¢ Live';
                    document.getElementById('connection').className = 'connected';
                };

                ws.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        log('üì® Received update');
                        if (data.type === 'board_update' && playerId) {
                            renderBoard(data.data);
                        }
                    } catch (err) {
                        log('‚ùå Parse error: ' + err.message);
                    }
                };

                ws.onclose = () => {
                    log('‚ùå WebSocket closed');
                    document.getElementById('connection').textContent = '‚ö´ Offline';
                    document.getElementById('connection').className = 'disconnected';
                    setTimeout(connectWS, 3000);
                };
            } catch (err) {
                log('‚ùå WebSocket error: ' + err.message);
            }
        }

        async function startGame() {
            playerId = document.getElementById('playerId').value.trim();
            if (!playerId) {
                showStatus('Please enter your name!', 'error');
                return;
            }

            const width = parseInt(document.getElementById('width').value) || 4;
            const height = parseInt(document.getElementById('height').value) || 4;

            document.getElementById('player').textContent = playerId;
            log(`üéÆ Creating new ${width}x${height} game for ${playerId}`);

            try {
                const response = await fetch(`/api/newgame?playerId=${playerId}&width=${width}&height=${height}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.ok) {
                    showStatus(data.message || 'Game started!', 'success');
                    renderBoard(data);
                } else {
                    showStatus('Failed to start game', 'error');
                }
            } catch (err) {
                log(`‚ùå Error: ${err.message}`);
                showStatus('Error: ' + err.message, 'error');
            }
        }

        async function refreshBoard() {
            if (!playerId) return;

            try {
                log(`üì° Fetching board for ${playerId}`);
                const response = await fetch(`/api/look?playerId=${playerId}`);
                const data = await response.json();
                log(`‚úÖ Got response`);
                renderBoard(data);
            } catch (err) {
                log(`‚ùå Fetch error: ${err.message}`);
                showStatus('Error: ' + err.message, 'error');
            }
        }

        function renderBoard(data) {
            log(`üé® Rendering board`);
            const boardDiv = document.getElementById('board');

            const width = data.width || 4;
            const height = data.height || 4;
            const board = data.board || [];

            log(`Board size: ${width}x${height}`);

            document.getElementById('size').textContent = `${width}√ó${height}`;
            boardDiv.style.gridTemplateColumns = `repeat(${width}, 1fr)`;
            boardDiv.innerHTML = '';

            for (let row = 0; row < height; row++) {
                for (let col = 0; col < width; col++) {
                    const cell = board[row] && board[row][col] ? board[row][col] : { state: 'down' };
                    const card = document.createElement('div');
                    card.className = `card ${cell.state || 'down'}`;
                    card.dataset.row = row;
                    card.dataset.col = col;

                    // Display card content
                    if (cell.state === 'none') {
                        card.textContent = '';
                    } else if (cell.state === 'down') {
                        card.textContent = '?';
                    } else {
                        card.textContent = cell.card || '?';
                    }

                    // Add click handler
                    // if (cell.state !== 'none') {
                    //     card.onclick = () => flipCard(row, col);
                    // }
                    card.onclick = () => flipCard(row, col);

                    boardDiv.appendChild(card);
                }
            }

            log(`‚úÖ Rendered board`);
        }

        async function flipCard(row, col) {
            if (!playerId) {
                showStatus('Enter your name first!', 'error');
                return;
            }

            log(`üéØ Flipping card at (${row}, ${col})`);

            try {
                const url = `/api/flip?playerId=${playerId}&row=${row}&column=${col}`;
                log(`üì§ POST ${url}`);

                const response = await fetch(url, { method: 'POST' });
                const data = await response.json();

                log(`‚úÖ Flip response: ${data.ok ? 'success' : 'fail'}`);

                if (data.ok) {
                    showStatus(data.message || 'Card flipped!', 'success');
                    renderBoard(data);
                    setTimeout(refreshBoard, 200);
                } else {
                    showStatus(data.message || 'Failed', 'error');
                }
            } catch (err) {
                log(`‚ùå Flip error: ${err.message}`);
                showStatus('Error: ' + err.message, 'error');
            }
        }

        function showStatus(msg, type) {
            const status = document.getElementById('status');
            status.textContent = msg;
            status.className = `status ${type} show`;
            setTimeout(() => status.classList.remove('show'), 3000);
        }

        // Initialize
        connectWS();

        // Auto-refresh every 2 seconds if player is active
        setInterval(() => {
            if (playerId) refreshBoard();
        }, 2000);
    </script>
</body>
</html>
